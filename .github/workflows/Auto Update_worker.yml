name: _workerè„šæœ¬è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼ˆåŒ—äº¬æ—¶é—´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      update_mode:
        description: 'æ›´æ–°æ¨¡å¼'
        required: false
        default: 'è‡ªåŠ¨'
        type: choice
        options:
          - 'è‡ªåŠ¨'
          - 'æ‰‹åŠ¨'
      obfuscate:
        description: 'æ˜¯å¦æ··æ·†ä»£ç '
        required: false
        default: 'å¦'
        type: choice
        options:
          - 'æ˜¯'
          - 'å¦'
      force:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå½»åº•æ¸…ç†åé‡æ–°åˆ›å»ºï¼‰'
        required: false
        default: false
        type: boolean

  push:
    branches: [ main ]
  
  schedule:
    - cron: '0 16 * * *'  # åŒ—äº¬æ—¶é—´0ç‚¹ï¼ˆUTC 16ç‚¹ï¼‰

env:
  CONFIG_FILE: 'æ›´æ–°è®°å½•.txt'
  WORKER_FILE: '_worker.js'
  TZ: 'Asia/Shanghai'  # è®¾ç½®å…¨å±€æ—¶åŒº

jobs:
  update-worker:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # åˆå§‹åŒ–é˜¶æ®µ ----------------------------------
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # é…ç½®ç®¡ç†é˜¶æ®µ ----------------------------------
    - name: åˆå§‹åŒ–æ›´æ–°è®°å½•
      id: init_config
      run: |
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "æ­£åœ¨åˆå§‹åŒ–æ›´æ–°è®°å½•æ–‡ä»¶..."
          echo "ã€_workerè„šæœ¬æ›´æ–°è®°å½•ã€‘
          æ›´æ–°æ¨¡å¼: è‡ªåŠ¨
          ä»£ç æ··æ·†: å¦
          æœ€åæ›´æ–°æ—¶é—´: ä»æœªæ›´æ–°
          æ—¶åŒº: åŒ—äº¬æ—¶é—´(UTC+8)
          " > $CONFIG_FILE
        fi

    # æ¨¡å¼åˆ¤æ–­é˜¶æ®µ ----------------------------------
    - name: ç¡®å®šè¿è¡Œæ¨¡å¼
      id: determine_mode
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          UPDATE_MODE="${{ github.event.inputs.update_mode || 'è‡ªåŠ¨' }}"
          OBFUSCATE="${{ github.event.inputs.obfuscate || 'å¦' }}"
          echo "[æ‰‹åŠ¨è§¦å‘] æ¨¡å¼: $UPDATE_MODE, æ··æ·†: $OBFUSCATE"
        else
          UPDATE_MODE=$(grep -oP 'æ›´æ–°æ¨¡å¼: \K\S+' $CONFIG_FILE || echo "è‡ªåŠ¨")
          OBFUSCATE=$(grep -oP 'ä»£ç æ··æ·†: \K\S+' $CONFIG_FILE || echo "å¦")
          echo "[è‡ªåŠ¨è§¦å‘] æ¨¡å¼: $UPDATE_MODE, æ··æ·†: $OBFUSCATE"
        fi

        echo "update_mode=$UPDATE_MODE" >> $GITHUB_OUTPUT
        echo "obfuscate=$OBFUSCATE" >> $GITHUB_OUTPUT

        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          sed -i "s/æ›´æ–°æ¨¡å¼: .*/æ›´æ–°æ¨¡å¼: $UPDATE_MODE/" $CONFIG_FILE
          sed -i "s/ä»£ç æ··æ·†: .*/ä»£ç æ··æ·†: $OBFUSCATE/" $CONFIG_FILE
        fi

    # æ›´æ–°æ£€æŸ¥é˜¶æ®µ ----------------------------------
    - name: æ£€æŸ¥æ›´æ–°æ¡ä»¶
      id: check_update
      run: |
        if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
          echo "å¼ºåˆ¶æ›´æ–°æ¨¡å¼æ¿€æ´»"
          echo "should_update=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [[ "${{ steps.determine_mode.outputs.update_mode }}" == "æ‰‹åŠ¨" ]] && 
           [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
          echo "æ‰‹åŠ¨æ¨¡å¼è·³è¿‡è‡ªåŠ¨æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
        else
          echo "ç¬¦åˆæ›´æ–°æ¡ä»¶"
          echo "should_update=true" >> $GITHUB_OUTPUT
        fi

    # å¼ºåˆ¶æ›´æ–°é¢„å¤„ç†é˜¶æ®µ ----------------------------------
    - name: å¼ºåˆ¶æ›´æ–°é¢„å¤„ç†
      if: ${{ github.event.inputs.force == 'true' }}
      run: |
        echo "æ­£åœ¨æ¸…ç†æ—§æ–‡ä»¶..."
        BACKUP_DIR="backup_$(date +%Y%m%d-%H%M%S)"
        echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
        
        mkdir -p "$BACKUP_DIR"
        
        if [ -f "$WORKER_FILE" ]; then
          cp "$WORKER_FILE" "$BACKUP_DIR/"
          echo "å·²å¤‡ä»½_workeræ–‡ä»¶åˆ°$BACKUP_DIR"
        fi
        
        rm -f "$WORKER_FILE"
        echo "æ—§æ–‡ä»¶æ¸…ç†å®Œæˆ"

    # æ–‡ä»¶æ›´æ–°é˜¶æ®µ ----------------------------------
    - name: æ‰§è¡Œæ–‡ä»¶æ›´æ–°
      if: steps.check_update.outputs.should_update == 'true'
      run: |
        echo "æ­£åœ¨ä¸‹è½½æœ€æ–°_workerè„šæœ¬..."
        DOWNLOAD_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js"
        
        if curl -fsSo "$WORKER_FILE.tmp" "$DOWNLOAD_URL" && grep -q 'addEventListener' "$WORKER_FILE.tmp"; then
          mv "$WORKER_FILE.tmp" "$WORKER_FILE"
          echo "ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(wc -c < "$WORKER_FILE" | numfmt --to=iec)"
        else
          echo "ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶æ— æ•ˆ"
          if [[ "${{ github.event.inputs.force }}" == "true" && -f "$BACKUP_DIR/$WORKER_FILE" ]]; then
            cp "$BACKUP_DIR/$WORKER_FILE" .
            echo "å·²æ¢å¤å¤‡ä»½æ–‡ä»¶"
          fi
          exit 1
        fi

    # ä»£ç æ··æ·†é˜¶æ®µ ----------------------------------
    - name: æ‰§è¡Œä»£ç æ··æ·†
      if: |
        (steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true') &&
        steps.determine_mode.outputs.obfuscate == 'æ˜¯'
      run: |
        echo "æ­£åœ¨æ··æ·†ä»£ç ..."
        npm install -g javascript-obfuscator
        
        ORIGINAL_SIZE=$(wc -c < "$WORKER_FILE" | numfmt --to=iec)
        if javascript-obfuscator "$WORKER_FILE" --output "$WORKER_FILE" \
          --options-preset high-obfuscation; then
          echo "æ··æ·†æˆåŠŸï¼æ–‡ä»¶å¤§å°: $ORIGINAL_SIZE â†’ $(wc -c < "$WORKER_FILE" | numfmt --to=iec)"
        else
          echo "æ··æ·†å¤±è´¥"
          if [[ "${{ github.event.inputs.force }}" == "true" && -f "$BACKUP_DIR/$WORKER_FILE" ]]; then
            cp "$BACKUP_DIR/$WORKER_FILE" .
            echo "å·²æ¢å¤åŸå§‹æ–‡ä»¶"
          fi
          exit 1
        fi

    # è·å–æäº¤è®°å½•é˜¶æ®µ -------------------------------
    - name: è·å–_worker.jsæäº¤è®°å½•
      id: get_commits
      run: |
        echo "æ­£åœ¨è·å–_worker.jsæäº¤è®°å½•..."
        # è·å–æœ€æ–°æäº¤å¹¶æ ¼å¼åŒ–è¾“å‡º
        LATEST_COMMIT=$(curl -s "https://api.github.com/repos/cmliu/edgetunnel/commits?path=_worker.js&per_page=1" | \
                  jq -r '.[] | "ğŸ“… \(.commit.author.date | sub("T.*"; ""))|ğŸ“ \(.commit.message | gsub("\n"; " "))"')
        
        # å¦‚æœæ²¡æœ‰è·å–åˆ°è®°å½•åˆ™æ˜¾ç¤ºæç¤º
        if [ -z "$LATEST_COMMIT" ]; then
          LATEST_COMMIT="ğŸ“… æš‚æ— æäº¤æ—¶é—´|ğŸ“ æš‚æ— æ›´æ–°å†…å®¹"
        fi
        
        echo "LATEST_COMMIT<<EOF" >> $GITHUB_ENV
        echo "$LATEST_COMMIT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "æäº¤è®°å½•è·å–å®Œæˆ"

    # æ›´æ–°è®°å½•é˜¶æ®µ ----------------------------------
    - name: æ›´æ–°è®°å½•æ–‡ä»¶
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        CURRENT_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        COMMIT_DATE=$(echo "${{ env.LATEST_COMMIT }}" | cut -d'|' -f1)
        COMMIT_MSG=$(echo "${{ env.LATEST_COMMIT }}" | cut -d'|' -f2)
        
        echo "ã€_workerè„šæœ¬æ›´æ–°è®°å½•ã€‘
        ğŸ”„ æ›´æ–°æ¨¡å¼: ${{ steps.determine_mode.outputs.update_mode }}
        ğŸ”’ ä»£ç æ··æ·†: ${{ steps.determine_mode.outputs.obfuscate }}
        â° æœ€åæ›´æ–°æ—¶é—´: $CURRENT_TIME (åŒ—äº¬æ—¶é—´)
        ğŸ’¥ æ›´æ–°ç±»å‹: ${{ github.event.inputs.force == 'true' && 'å¼ºåˆ¶æ¸…ç†æ›´æ–°' || 'å¸¸è§„æ›´æ–°' }}
        ğŸŒ æ—¶åŒº: åŒ—äº¬æ—¶é—´(UTC+8)

        $COMMIT_DATE
        $COMMIT_MSG
        " > "$CONFIG_FILE"
        
        if [[ -n "$BACKUP_DIR" && -d "$BACKUP_DIR" ]]; then
          rm -rf "$BACKUP_DIR"
          echo "å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†"
        fi
        
        echo "æ›´æ–°è®°å½•å·²åˆ·æ–°"

    # ç”ŸæˆREADME.mdæ–‡æ¡£ ----------------------------
    - name: ç”ŸæˆREADME.md
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        echo "# _workerè„šæœ¬è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ

        ## ğŸ“Œ ä½¿ç”¨è¯´æ˜

        è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°Cloudflare _workerè„šæœ¬çš„å·¥ä½œæµï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

        - **è‡ªåŠ¨æ›´æ–°**ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´0ç‚¹æ£€æŸ¥æ›´æ–°
        - **æ‰‹åŠ¨è§¦å‘**ï¼šå¯æŒ‡å®šæ›´æ–°æ¨¡å¼å’Œæ··æ·†é€‰é¡¹
        - **ä»£ç æ··æ·†**ï¼šå¯é€‰é«˜å¼ºåº¦æ··æ·†ä¿æŠ¤ä»£ç 
        - **å¼ºåˆ¶æ›´æ–°**ï¼šå½»åº•æ¸…ç†åé‡æ–°åˆ›å»º_workerè„šæœ¬
        - **å˜æ›´è¿½è¸ª**ï¼šè‡ªåŠ¨è®°å½•æœ€æ–°æäº¤ä¿¡æ¯

        ## âš™ï¸ é…ç½®é€‰é¡¹è¯´æ˜

        | æè¿° | å¯é€‰å€¼ | é»˜è®¤å€¼ | é€‚ç”¨åœºæ™¯ |
        |------|--------|--------|----------|
        | æ›´æ–°æ¨¡å¼ | è‡ªåŠ¨, æ‰‹åŠ¨ | è‡ªåŠ¨ | æ‰‹åŠ¨è§¦å‘/è‡ªåŠ¨æ›´æ–° |
        | æ˜¯å¦æ··æ·†ä»£ç  | æ˜¯, å¦ | å¦ | æ‰‹åŠ¨è§¦å‘/è‡ªåŠ¨æ›´æ–° |
        | å¼ºåˆ¶æ›´æ–°(å½»åº•æ¸…ç†åé‡æ–°åˆ›å»º) | âˆš, å£ | å£ | æ‰‹åŠ¨è§¦å‘ |

        ## âš ï¸ æ³¨æ„äº‹é¡¹

        1. **å¼ºåˆ¶æ›´æ–°**ä¼šåˆ é™¤ç°æœ‰_workerè„šæœ¬å¹¶é‡æ–°ä¸‹è½½ï¼Œè¯·è°¨æ…ä½¿ç”¨
        2. ä»£ç æ··æ·†åå¯èƒ½å½±å“è°ƒè¯•ï¼Œå»ºè®®æµ‹è¯•ç¯å¢ƒå…ˆç¦ç”¨æ··æ·†
        3. è‡ªåŠ¨æ›´æ–°ä»…åœ¨æ›´æ–°æ¨¡å¼ä¸ºã€Œè‡ªåŠ¨ã€æ—¶ç”Ÿæ•ˆ

        ## ğŸ”„ æœ€è¿‘æ›´æ–°è®°å½•

        \`\`\`
        $(cat $CONFIG_FILE)
        \`\`\`

        > æœ€åç”Ÿæˆæ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´")
        " > README.md

        echo "README.md å·²ç”Ÿæˆ/æ›´æ–°"

    # æäº¤å˜æ›´é˜¶æ®µ ----------------------------------
    - name: æäº¤å˜æ›´
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add .
        
        if ! git diff --cached --quiet; then
          COMMIT_MSG="æ›´æ–°_workerè„šæœ¬[æ¨¡å¼:${{ steps.determine_mode.outputs.update_mode }}][æ··æ·†:${{ steps.determine_mode.outputs.obfuscate }}][åŒ—äº¬æ—¶é—´]"
          
          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            COMMIT_MSG="å¼ºåˆ¶æ›´æ–°_workerè„šæœ¬[æ¨¡å¼:${{ steps.determine_mode.outputs.update_mode }}][æ··æ·†:${{ steps.determine_mode.outputs.obfuscate }}][åŒ—äº¬æ—¶é—´]"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "å˜æ›´å·²æäº¤"
        else
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
        fi
