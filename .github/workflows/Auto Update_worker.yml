name: _workerè„šæœ¬è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼ˆåŒ—äº¬æ—¶é—´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      update_mode:
        description: 'æ›´æ–°æ¨¡å¼'
        required: false
        default: 'è‡ªåŠ¨'
        type: choice
        options:
          - 'è‡ªåŠ¨'
          - 'æ‰‹åŠ¨'
      obfuscate:
        description: 'æ˜¯å¦æ··æ·†ä»£ç '
        required: false
        default: 'å¦'
        type: choice
        options:
          - 'æ˜¯'
          - 'å¦'
      force:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå½»åº•æ¸…ç†åé‡æ–°åˆ›å»ºï¼‰'
        required: false
        default: false
        type: boolean

  push:
    branches: [ main ]
  
  schedule:
    - cron: '0 16 * * *'  # åŒ—äº¬æ—¶é—´0ç‚¹ï¼ˆUTC 16ç‚¹ï¼‰

env:
  WORKER_FILE: '_worker.js'
  TZ: 'Asia/Shanghai'  # è®¾ç½®å…¨å±€æ—¶åŒº

jobs:
  update-worker:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # åˆå§‹åŒ–é˜¶æ®µ ----------------------------------
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # æ¨¡å¼åˆ¤æ–­é˜¶æ®µ ----------------------------------
    - name: ç¡®å®šè¿è¡Œæ¨¡å¼
      id: determine_mode
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          UPDATE_MODE="${{ github.event.inputs.update_mode || 'è‡ªåŠ¨' }}"
          OBFUSCATE="${{ github.event.inputs.obfuscate || 'å¦' }}"
          echo "[æ‰‹åŠ¨è§¦å‘] æ¨¡å¼: $UPDATE_MODE, æ··æ·†: $OBFUSCATE"
        else
          if grep -q 'æ›´æ–°æ¨¡å¼: ' README.md; then
            UPDATE_MODE=$(grep -oP 'æ›´æ–°æ¨¡å¼: \K\S+' README.md || echo "è‡ªåŠ¨")
            OBFUSCATE=$(grep -oP 'ä»£ç æ··æ·†: \K\S+' README.md || echo "å¦")
          else
            UPDATE_MODE="è‡ªåŠ¨"
            OBFUSCATE="å¦"
          fi
          echo "[è‡ªåŠ¨è§¦å‘] æ¨¡å¼: $UPDATE_MODE, æ··æ·†: $OBFUSCATE"
        fi

        echo "update_mode=$UPDATE_MODE" >> $GITHUB_OUTPUT
        echo "obfuscate=$OBFUSCATE" >> $GITHUB_OUTPUT

    # æ›´æ–°æ£€æŸ¥é˜¶æ®µ ----------------------------------
    - name: æ£€æŸ¥æ›´æ–°æ¡ä»¶
      id: check_update
      run: |
        if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
          echo "å¼ºåˆ¶æ›´æ–°æ¨¡å¼æ¿€æ´»"
          echo "should_update=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [[ "${{ steps.determine_mode.outputs.update_mode }}" == "æ‰‹åŠ¨" ]] && 
           [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
          echo "æ‰‹åŠ¨æ¨¡å¼è·³è¿‡è‡ªåŠ¨æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
        else
          echo "ç¬¦åˆæ›´æ–°æ¡ä»¶"
          echo "should_update=true" >> $GITHUB_OUTPUT
        fi

    # å¼ºåˆ¶æ›´æ–°é¢„å¤„ç†é˜¶æ®µ ----------------------------------
    - name: å¼ºåˆ¶æ›´æ–°é¢„å¤„ç†
      if: ${{ github.event.inputs.force == 'true' }}
      run: |
        echo "æ­£åœ¨æ¸…ç†ä»“åº“ï¼ˆä¿ç•™å·¥ä½œæµæ–‡ä»¶ï¼‰..."
        BACKUP_DIR="backup_$(date +%Y%m%d-%H%M%S)"
        echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
        
        # åˆ›å»ºå¤‡ä»½ç›®å½•
        mkdir -p "$BACKUP_DIR"
        
        # å¤‡ä»½é‡è¦æ–‡ä»¶
        if [ -f "$WORKER_FILE" ]; then
          cp "$WORKER_FILE" "$BACKUP_DIR/"
          echo "å·²å¤‡ä»½_workeræ–‡ä»¶åˆ°$BACKUP_DIR"
        fi
        
        if [ -f "README.md" ]; then
          cp "README.md" "$BACKUP_DIR/"
          echo "å·²å¤‡ä»½README.mdåˆ°$BACKUP_DIR"
        fi
        
        # åˆ é™¤é™¤å·¥ä½œæµæ–‡ä»¶å¤–çš„æ‰€æœ‰æ–‡ä»¶
        find . -mindepth 1 -maxdepth 1 ! -name '.github' ! -name '.git' -exec rm -rf {} +
        echo "ä»“åº“æ¸…ç†å®Œæˆï¼Œä»…ä¿ç•™å·¥ä½œæµæ–‡ä»¶"

    # æ–‡ä»¶æ›´æ–°é˜¶æ®µ ----------------------------------
    - name: æ‰§è¡Œæ–‡ä»¶æ›´æ–°
      if: steps.check_update.outputs.should_update == 'true'
      run: |
        echo "æ­£åœ¨ä¸‹è½½æœ€æ–°_workerè„šæœ¬..."
        DOWNLOAD_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js"
        
        if curl -fsSo "$WORKER_FILE.tmp" "$DOWNLOAD_URL" && grep -q 'addEventListener' "$WORKER_FILE.tmp"; then
          mv "$WORKER_FILE.tmp" "$WORKER_FILE"
          echo "ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(wc -c < "$WORKER_FILE" | numfmt --to=iec)"
          
          # å¼ºåˆ¶æ›´æ–°æˆåŠŸååˆ é™¤å¤‡ä»½
          if [[ "${{ github.event.inputs.force }}" == "true" && -d "$BACKUP_DIR" ]]; then
            echo "æ­£åœ¨æ¸…ç†å¤‡ä»½æ–‡ä»¶..."
            rm -rf "$BACKUP_DIR"
            echo "å¤‡ä»½æ–‡ä»¶å·²åˆ é™¤"
          fi
        else
          echo "ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶æ— æ•ˆ"
          if [[ "${{ github.event.inputs.force }}" == "true" && -d "$BACKUP_DIR" ]]; then
            echo "æ­£åœ¨æ¢å¤å¤‡ä»½æ–‡ä»¶..."
            cp "$BACKUP_DIR"/* . || true
            echo "å·²æ¢å¤å¤‡ä»½æ–‡ä»¶"
          fi
          exit 1
        fi

    # ä»£ç æ··æ·†é˜¶æ®µ ----------------------------------
    - name: æ‰§è¡Œä»£ç æ··æ·†
      if: |
        (steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true') &&
        steps.determine_mode.outputs.obfuscate == 'æ˜¯'
      run: |
        echo "æ­£åœ¨æ··æ·†ä»£ç ..."
        npm install -g javascript-obfuscator
        
        ORIGINAL_SIZE=$(wc -c < "$WORKER_FILE" | numfmt --to=iec)
        if javascript-obfuscator "$WORKER_FILE" --output "$WORKER_FILE" \
          --options-preset high-obfuscation; then
          echo "æ··æ·†æˆåŠŸï¼æ–‡ä»¶å¤§å°: $ORIGINAL_SIZE â†’ $(wc -c < "$WORKER_FILE" | numfmt --to=iec)"
        else
          echo "æ··æ·†å¤±è´¥"
          if [[ "${{ github.event.inputs.force }}" == "true" && -d "$BACKUP_DIR" ]]; then
            cp "$BACKUP_DIR"/* . || true
            echo "å·²æ¢å¤åŸå§‹æ–‡ä»¶"
          fi
          exit 1
        fi

    # è·å–æäº¤è®°å½•é˜¶æ®µ -------------------------------
    - name: è·å–_worker.jsæäº¤è®°å½•
      id: get_commits
      run: |
        echo "æ­£åœ¨è·å–_worker.jsæäº¤è®°å½•..."
        LATEST_COMMIT=$(curl -s "https://api.github.com/repos/cmliu/edgetunnel/commits?path=_worker.js&per_page=1" | \
                  jq -r '.[] | "ğŸ“… \(.commit.author.date | sub("T.*"; ""))|ğŸ“ \(.commit.message | gsub("\n"; " "))"')
        
        if [ -z "$LATEST_COMMIT" ]; then
          LATEST_COMMIT="ğŸ“… æš‚æ— æäº¤æ—¶é—´|ğŸ“ æš‚æ— æ›´æ–°å†…å®¹"
        fi
        
        echo "LATEST_COMMIT<<EOF" >> $GITHUB_ENV
        echo "$LATEST_COMMIT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "æäº¤è®°å½•è·å–å®Œæˆ"

    # ç”ŸæˆREADME.mdæ–‡æ¡£ ----------------------------
    - name: ç”ŸæˆREADME.md
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        CURRENT_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        COMMIT_DATE=$(echo "${{ env.LATEST_COMMIT }}" | cut -d'|' -f1)
        COMMIT_MSG=$(echo "${{ env.LATEST_COMMIT }}" | cut -d'|' -f2)
        
        echo "# _workerè„šæœ¬è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ

        ## ğŸ“Œ çŠ¶æ€å¾½ç« 

        ![å·¥ä½œæµçŠ¶æ€](https://img.shields.io/badge/å·¥ä½œæµ-è¿è¡Œä¸­-brightgreen?style=flat-square)
        ![æ›´æ–°æ¨¡å¼](https://img.shields.io/badge/æ›´æ–°æ¨¡å¼-${{ steps.determine_mode.outputs.update_mode }}-green?style=flat-square)
        ![ä»£ç æ··æ·†](https://img.shields.io/badge/ä»£ç æ··æ·†-${{ steps.determine_mode.outputs.obfuscate }}-orange?style=flat-square)
        ![æœ€åæ›´æ–°](https://img.shields.io/badge/æœ€åæ›´æ–°-$(date +%Y--%m--%d)-blue?style=flat-square)

        ## ğŸ“š ä½¿ç”¨è¯´æ˜

        è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°_workerè„šæœ¬çš„å·¥ä½œæµï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

        - **è‡ªåŠ¨æ›´æ–°**ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´0ç‚¹æ£€æŸ¥æ›´æ–°
        - **æ‰‹åŠ¨è§¦å‘**ï¼šå¯æŒ‡å®šæ›´æ–°æ¨¡å¼å’Œæ··æ·†é€‰é¡¹
        - **ä»£ç æ··æ·†**ï¼šå¯é€‰é«˜å¼ºåº¦æ··æ·†ä¿æŠ¤ä»£ç 
        - **å¼ºåˆ¶æ›´æ–°**ï¼šå½»åº•æ¸…ç†ä»“åº“åé‡æ–°åˆ›å»º_workerè„šæœ¬ï¼ˆä¿ç•™å·¥ä½œæµæ–‡ä»¶ï¼‰
        - **å˜æ›´è¿½è¸ª**ï¼šè‡ªåŠ¨è®°å½•æœ€æ–°æäº¤ä¿¡æ¯

        ## âš™ï¸ å½“å‰é…ç½®

        | é…ç½®é¡¹ | å€¼ |
        |--------|----|
        | ğŸ”„ æ›´æ–°æ¨¡å¼ | ${{ steps.determine_mode.outputs.update_mode }} |
        | ğŸ”’ ä»£ç æ··æ·† | ${{ steps.determine_mode.outputs.obfuscate }} |
        | â° æœ€åæ›´æ–°æ—¶é—´ | $CURRENT_TIME (åŒ—äº¬æ—¶é—´) |
        | ğŸ’¥ æ›´æ–°ç±»å‹ | ${{ github.event.inputs.force == 'true' && 'å¼ºåˆ¶æ¸…ç†æ›´æ–°' || 'å¸¸è§„æ›´æ–°' }} |
        | ğŸŒ æ—¶åŒº | åŒ—äº¬æ—¶é—´(UTC+8) |

        ## âš™ï¸ é…ç½®é€‰é¡¹è¯´æ˜

        ### 1. æ›´æ–°æ¨¡å¼
        - **è‡ªåŠ¨**ï¼šç³»ç»Ÿå°†æŒ‰è®¡åˆ’è‡ªåŠ¨æ£€æŸ¥æ›´æ–°ï¼ˆé»˜è®¤ï¼‰
        - **æ‰‹åŠ¨**ï¼šä»…é€šè¿‡æ‰‹åŠ¨è§¦å‘æ›´æ–°

        ### 2. ä»£ç æ··æ·†
        - **æ˜¯**ï¼šå¯ç”¨é«˜å¼ºåº¦ä»£ç æ··æ·†ï¼ˆä½¿ç”¨javascript-obfuscatorï¼‰
        - **å¦**ï¼šä¿æŒåŸå§‹ä»£ç ï¼ˆé»˜è®¤ï¼‰

        ### 3. å¼ºåˆ¶æ›´æ–°
        - **true**ï¼šå½»åº•æ¸…ç†ä»“åº“åé‡æ–°åˆ›å»ºï¼ˆä¿ç•™å·¥ä½œæµæ–‡ä»¶ï¼‰
        - **false**ï¼šå¸¸è§„æ›´æ–°ï¼ˆé»˜è®¤ï¼‰

        > æ³¨æ„ï¼šå¼ºåˆ¶æ›´æ–°ä¼šåˆ é™¤é™¤ \`.github\` å·¥ä½œæµç›®å½•å¤–çš„æ‰€æœ‰æ–‡ä»¶ï¼Œè¯·è°¨æ…ä½¿ç”¨

        ## âš ï¸ æ³¨æ„äº‹é¡¹

        1. **å¼ºåˆ¶æ›´æ–°**ä¼šåˆ é™¤é™¤å·¥ä½œæµæ–‡ä»¶å¤–çš„æ‰€æœ‰æ–‡ä»¶å¹¶é‡æ–°ä¸‹è½½ï¼Œè¯·è°¨æ…ä½¿ç”¨
        2. ä»£ç æ··æ·†åå¯èƒ½å½±å“è°ƒè¯•ï¼Œå»ºè®®æµ‹è¯•ç¯å¢ƒå…ˆç¦ç”¨æ··æ·†
        3. è‡ªåŠ¨æ›´æ–°ä»…åœ¨æ›´æ–°æ¨¡å¼ä¸ºã€Œè‡ªåŠ¨ã€æ—¶ç”Ÿæ•ˆ

        ## ğŸ”„ æœ€è¿‘æ›´æ–°è®°å½•

        $COMMIT_DATE  
        $COMMIT_MSG

        > æœ€åç”Ÿæˆæ—¶é—´: $CURRENT_TIME (åŒ—äº¬æ—¶é—´)
        " > README.md

        echo "README.md å·²ç”Ÿæˆ/æ›´æ–°"

    # æäº¤å˜æ›´é˜¶æ®µ ----------------------------------
    - name: æäº¤å˜æ›´
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add .
        
        if ! git diff --cached --quiet; then
          COMMIT_MSG="æ›´æ–°_workerè„šæœ¬[æ¨¡å¼:${{ steps.determine_mode.outputs.update_mode }}][æ··æ·†:${{ steps.determine_mode.outputs.obfuscate }}][åŒ—äº¬æ—¶é—´]"
          
          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            COMMIT_MSG="å¼ºåˆ¶æ›´æ–°_workerè„šæœ¬[æ¨¡å¼:${{ steps.determine_mode.outputs.update_mode }}][æ··æ·†:${{ steps.determine_mode.outputs.obfuscate }}][åŒ—äº¬æ—¶é—´]"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "å˜æ›´å·²æäº¤"
        else
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
        fi
