name: Workerè„šæœ¬è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼ˆå¢å¼ºå¼ºåˆ¶æ›´æ–°ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      update_mode:
        description: 'æ›´æ–°æ¨¡å¼'
        required: false
        default: 'è‡ªåŠ¨'
        type: choice
        options:
          - 'è‡ªåŠ¨'
          - 'æ‰‹åŠ¨'
      obfuscate:
        description: 'æ˜¯å¦æ··æ·†ä»£ç '
        required: false
        default: 'å¦'
        type: choice
        options:
          - 'æ˜¯'
          - 'å¦'
      force:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ–‡ä»¶ï¼ˆå½»åº•æ¸…ç†åé‡æ–°åˆ›å»ºï¼‰'
        required: false
        default: false
        type: boolean

  push:
    branches: [ main ]
  
  schedule:
    - cron: '0 16 * * *'  # åŒ—äº¬æ—¶é—´0ç‚¹ï¼ˆUTC 16ç‚¹ï¼‰

env:
  CONFIG_FILE: 'æ›´æ–°è®°å½•.txt'
  WORKER_FILE: 'worker.js'
  TZ: 'Asia/Shanghai'
  CLEAN_FILES: '*.js *.txt'  # å¼ºåˆ¶æ›´æ–°æ—¶è¦æ¸…ç†çš„æ–‡ä»¶æ¨¡å¼

jobs:
  update-worker:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # åˆå§‹åŒ–é˜¶æ®µ ----------------------------------
    - name: æ£€å‡ºä»£ç åº“ï¼ˆå®Œå…¨æ£€å‡ºï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # é…ç½®ç®¡ç†é˜¶æ®µ ----------------------------------
    - name: åˆå§‹åŒ–æ›´æ–°è®°å½•
      id: init_config
      run: |
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "æ­£åœ¨åˆå§‹åŒ–æ›´æ–°è®°å½•æ–‡ä»¶..."
          echo "ã€Workerè„šæœ¬æ›´æ–°è®°å½•ã€‘
          æ›´æ–°æ¨¡å¼: è‡ªåŠ¨
          ä»£ç æ··æ·†: å¦
          æœ€åæ›´æ–°æ—¶é—´: ä»æœªæ›´æ–°
          æ—¶åŒº: åŒ—äº¬æ—¶é—´(UTC+8)
          " > $CONFIG_FILE
        fi

    # æ¨¡å¼åˆ¤æ–­é˜¶æ®µ ----------------------------------
    - name: ç¡®å®šè¿è¡Œæ¨¡å¼
      id: determine_mode
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          UPDATE_MODE="${{ github.event.inputs.update_mode || 'è‡ªåŠ¨' }}"
          OBFUSCATE="${{ github.event.inputs.obfuscate || 'å¦' }}"
          echo "[æ‰‹åŠ¨è§¦å‘] æ¨¡å¼: $UPDATE_MODE, æ··æ·†: $OBFUSCATE"
        else
          UPDATE_MODE=$(grep -oP 'æ›´æ–°æ¨¡å¼: \K\S+' $CONFIG_FILE || echo "è‡ªåŠ¨")
          OBFUSCATE=$(grep -oP 'ä»£ç æ··æ·†: \K\S+' $CONFIG_FILE || echo "å¦")
          echo "[è‡ªåŠ¨è§¦å‘] æ¨¡å¼: $UPDATE_MODE, æ··æ·†: $OBFUSCATE"
        fi

        echo "update_mode=$UPDATE_MODE" >> $GITHUB_OUTPUT
        echo "obfuscate=$OBFUSCATE" >> $GITHUB_OUTPUT

        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          sed -i "s/æ›´æ–°æ¨¡å¼: .*/æ›´æ–°æ¨¡å¼: $UPDATE_MODE/" $CONFIG_FILE
          sed -i "s/ä»£ç æ··æ·†: .*/ä»£ç æ··æ·†: $OBFUSCATE/" $CONFIG_FILE
        fi

    # å¼ºåˆ¶æ›´æ–°é¢„å¤„ç†é˜¶æ®µï¼ˆå¢å¼ºç‰ˆï¼‰--------------------------
    - name: å¼ºåˆ¶æ›´æ–°é¢„å¤„ç†
      if: ${{ github.event.inputs.force == 'true' }}
      run: |
        echo "=== å¼€å§‹å¼ºåˆ¶æ›´æ–°é¢„å¤„ç† ==="
        BACKUP_DIR="backup_$(date +%Y%m%d-%H%M%S)"
        echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
        
        # åˆ›å»ºå¤‡ä»½ç›®å½•
        mkdir -p "$BACKUP_DIR"
        
        # å¤‡ä»½æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶
        for file in $CLEAN_FILES; do
          if ls $file 1> /dev/null 2>&1; then
            echo "å¤‡ä»½æ–‡ä»¶: $file"
            cp $file "$BACKUP_DIR/" || true
          fi
        done

        # æ¸…ç†æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶
        echo "æ¸…ç†ç›®æ ‡æ–‡ä»¶..."
        rm -f $CLEAN_FILES || true
        
        # éªŒè¯æ¸…ç†ç»“æœ
        echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        echo "=== å¼ºåˆ¶æ›´æ–°é¢„å¤„ç†å®Œæˆ ==="

    # æ–‡ä»¶æ›´æ–°é˜¶æ®µï¼ˆå¢å¼ºç‰ˆï¼‰------------------------------
    - name: æ‰§è¡Œæ–‡ä»¶æ›´æ–°
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        echo "=== å¼€å§‹æ–‡ä»¶æ›´æ–° ==="
        DOWNLOAD_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js"
        TEMP_FILE="$WORKER_FILE.tmp"
        
        # ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
        echo "æ­£åœ¨ä»è¿œç¨‹ä¸‹è½½æœ€æ–°ç‰ˆæœ¬..."
        if ! curl -fsSo "$TEMP_FILE" "$DOWNLOAD_URL"; then
          echo "::error::ä¸‹è½½å¤±è´¥"
          exit 1
        fi

        # éªŒè¯æ–‡ä»¶æœ‰æ•ˆæ€§
        if ! grep -q 'addEventListener' "$TEMP_FILE"; then
          echo "::error::ä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆ"
          exit 1
        fi

        # åº”ç”¨æ›´æ–°
        mv "$TEMP_FILE" "$WORKER_FILE"
        echo "ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(wc -c < "$WORKER_FILE" | numfmt --to=iec)"
        
        # è®°å½•æ–‡ä»¶å“ˆå¸Œ
        FILE_HASH=$(sha256sum "$WORKER_FILE" | cut -d' ' -f1)
        echo "FILE_HASH=$FILE_HASH" >> $GITHUB_ENV
        echo "=== æ–‡ä»¶æ›´æ–°å®Œæˆ ==="

    # ä»£ç æ··æ·†é˜¶æ®µï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰---------------------------
    - name: æ‰§è¡Œä»£ç æ··æ·†
      if: |
        (steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true') &&
        steps.determine_mode.outputs.obfuscate == 'æ˜¯'
      run: |
        echo "=== å¼€å§‹ä»£ç æ··æ·† ==="
        npm install -g javascript-obfuscator
        
        ORIGINAL_HASH="$FILE_HASH"
        ORIGINAL_SIZE=$(wc -c < "$WORKER_FILE" | numfmt --to=iec)
        
        echo "æ··æ·†å‰æ–‡ä»¶å“ˆå¸Œ: $ORIGINAL_HASH"
        echo "æ··æ·†å‰æ–‡ä»¶å¤§å°: $ORIGINAL_SIZE"
        
        if ! javascript-obfuscator "$WORKER_FILE" --output "$WORKER_FILE" \
          --options-preset high-obfuscation; then
          echo "::error::æ··æ·†å¤±è´¥"
          exit 1
        fi

        # éªŒè¯æ··æ·†ç»“æœ
        OBFUSCATED_HASH=$(sha256sum "$WORKER_FILE" | cut -d' ' -f1)
        OBFUSCATED_SIZE=$(wc -c < "$WORKER_FILE" | numfmt --to=iec)
        
        echo "æ··æ·†åæ–‡ä»¶å“ˆå¸Œ: $OBFUSCATED_HASH"
        echo "æ··æ·†åæ–‡ä»¶å¤§å°: $ORIGINAL_SIZE â†’ $OBFUSCATED_SIZE"
        
        if [[ "$OBFUSCATED_HASH" == "$ORIGINAL_HASH" ]]; then
          echo "::warning::æ–‡ä»¶å“ˆå¸Œæœªæ”¹å˜ï¼Œå¯èƒ½æ··æ·†æœªç”Ÿæ•ˆ"
        fi
        
        echo "=== ä»£ç æ··æ·†å®Œæˆ ==="

    # è·å–æäº¤è®°å½•é˜¶æ®µ -------------------------------
    - name: è·å–æäº¤è®°å½•
      id: get_commits
      run: |
        echo "æ­£åœ¨è·å–æœ€æ–°æäº¤è®°å½•..."
        API_URL="https://api.github.com/repos/cmliu/edgetunnel/commits?path=_worker.js&per_page=1"
        
        if ! RESPONSE=$(curl -s "$API_URL"); then
          echo "LATEST_COMMIT=è·å–æäº¤è®°å½•å¤±è´¥" >> $GITHUB_ENV
          exit 0
        fi
        
        LATEST_COMMIT=$(echo "$RESPONSE" | jq -r '.[] | "ğŸ“… \(.commit.author.date | sub("T.*"; "")): \(.commit.message | gsub("\n"; " "))"')
        echo "LATEST_COMMIT=${LATEST_COMMIT:-'æš‚æ— æäº¤è®°å½•'}" >> $GITHUB_ENV

    # æ›´æ–°è®°å½•é˜¶æ®µ ----------------------------------
    - name: æ›´æ–°è®°å½•æ–‡ä»¶
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        CURRENT_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        UPDATE_TYPE="${{ github.event.inputs.force == 'true' && 'å¼ºåˆ¶æ›´æ–°' || 'å¸¸è§„æ›´æ–°' }}"
        
        echo "ã€Workerè„šæœ¬æ›´æ–°è®°å½•ã€‘
        ğŸ”„ æ›´æ–°æ¨¡å¼: ${{ steps.determine_mode.outputs.update_mode }}
        ğŸ”’ ä»£ç æ··æ·†: ${{ steps.determine_mode.outputs.obfuscate }}
        â° æœ€åæ›´æ–°æ—¶é—´: $CURRENT_TIME (åŒ—äº¬æ—¶é—´)
        ğŸ’¥ æ›´æ–°ç±»å‹: $UPDATE_TYPE
        ğŸŒ æ—¶åŒº: åŒ—äº¬æ—¶é—´(UTC+8)
        ğŸ“Œ æ–‡ä»¶çŠ¶æ€: ${{ steps.determine_mode.outputs.obfuscate == 'æ˜¯' && 'å·²æ··æ·†' || 'æœªæ··æ·†' }}

        ğŸ†• æœ€æ–°æäº¤: ${{ env.LATEST_COMMIT }}
        " > "$CONFIG_FILE"
        
        echo "æ›´æ–°è®°å½•å·²åˆ·æ–°"

    # æäº¤å˜æ›´é˜¶æ®µï¼ˆå¢å¼ºç‰ˆï¼‰---------------------------
    - name: æäº¤å˜æ›´
      if: steps.check_update.outputs.should_update == 'true' || github.event.inputs.force == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # æ·»åŠ æ‰€æœ‰å˜æ›´
        git add .
        
        if ! git diff --cached --quiet; then
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="Workerè„šæœ¬${{ github.event.inputs.force == 'true' && 'å¼ºåˆ¶' || '' }}æ›´æ–°"
          COMMIT_MSG+="[æ¨¡å¼:${{ steps.determine_mode.outputs.update_mode }}]"
          COMMIT_MSG+="[æ··æ·†:${{ steps.determine_mode.outputs.obfuscate }}]"
          COMMIT_MSG+="[åŒ—äº¬æ—¶é—´]"
          
          # æ‰§è¡Œæäº¤
          git commit -m "$COMMIT_MSG"
          git push
          echo "å˜æ›´å·²æäº¤: $COMMIT_MSG"
        else
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi
